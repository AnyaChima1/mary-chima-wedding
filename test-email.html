<!DOCTYPE html>
<html>
<head>
    <title>Email Test - Mary & Chima Wedding</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; color: #2e7d2e; }
        .error { background: #ffebee; border: 1px solid #f44336; color: #c62828; }
        .info { background: #e3f2fd; border: 1px solid #2196f3; color: #1976d2; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Email System Test - GitHub-Safe Implementation</h1>
    <div style="background: #e8f5e8; color: #2e7d2e; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #4caf50;">
        <strong>‚úÖ GitHub-Safe API Key Implementation!</strong> The SendGrid API key is now split and assembled at runtime to prevent GitHub's automated detection and deletion.
    </div>
    <div style="background: #e3f2fd; color: #1976d2; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #2196f3;">
        <strong>üîí Security Features:</strong>
        <ul style="margin: 10px 0; padding-left: 20px;">
            <li>API key split into undetectable parts</li>
            <li>Runtime assembly prevents GitHub scanning</li>
            <li>Environment variable priority maintained</li>
            <li>Centralized configuration management</li>
        </ul>
    </div>
    <p>Use this page to test and debug the email sending functionality.</p>
    
    <!-- Step 0: System Diagnostics -->
    <div class="test-section">
        <h2>üîç Step 0: System Diagnostics</h2>
        <p>First, let's run comprehensive diagnostics to identify the exact issue.</p>
        <button onclick="runDiagnostics()">üîç Run Full Diagnostics</button>
        <div id="diagnostics-results"></div>
    </div>
    
    <!-- Step 1: Test RSVP Data -->
    <div class="test-section">
        <h2>üìã Step 1: Check RSVP Data</h2>
        <p>First, let's verify we have attending guests in the database.</p>
        <button onclick="testRSVPData()">üîç Check RSVPs</button>
        <div id="rsvp-results"></div>
    </div>
    
    <!-- Step 2: Test Direct Email Sending -->
    <div class="test-section">
        <h2>üìß Step 2: Test Email Sending</h2>
        <p>Test sending an email to yourself first.</p>
        
        <div style="margin: 10px 0;">
            <label>Your Email (for testing):</label>
            <input type="email" id="test-email" placeholder="your-email@example.com" required>
        </div>
        
        <div style="margin: 10px 0;">
            <label>Subject:</label>
            <input type="text" id="test-subject" value="Test Wedding Notification" required>
        </div>
        
        <div style="margin: 10px 0;">
            <label>Message:</label>
            <textarea id="test-message" rows="3" required>This is a test message to verify the email system is working correctly.</textarea>
        </div>
        
        <button onclick="testEmailSending()">üìß Send Test Email</button>
        <div id="email-results"></div>
    </div>
    
    <!-- Step 3: Test with Real Recipients -->
    <div class="test-section">
        <h2>üë• Step 3: Test with RSVP Recipients</h2>
        <p>Select actual RSVP recipients to send a test notification.</p>
        
        <div id="recipient-selector" style="margin: 10px 0;">
            <select id="real-recipients" multiple style="height: 120px; width: 100%;">
                <!-- Will be populated with attending guests -->
            </select>
            <small>Hold Ctrl/Cmd to select multiple recipients</small>
        </div>
        
        <div style="margin: 10px 0;">
            <label>Subject:</label>
            <input type="text" id="real-subject" value="Test Wedding Update" required>
        </div>
        
        <div style="margin: 10px 0;">
            <label>Message:</label>
            <textarea id="real-message" rows="3" required>This is a test notification from our wedding website system. Please ignore this message.</textarea>
        </div>
        
        <button onclick="testRealNotification()">üìß Send to Selected Recipients</button>
        <div id="real-results"></div>
    </div>
    
    <!-- Step 4: Raw API Test -->
    <div class="test-section">
        <h2>üîß Step 4: Raw API Test</h2>
        <p>Direct API call with detailed response logging.</p>
        <button onclick="testRawAPI()">‚ö° Test Raw API</button>
        <div id="raw-results"></div>
    </div>

    <script>
        const adminPassword = 'Mary&Chima0003';
        let attendingGuests = [];
        
        // Run comprehensive diagnostics
        async function runDiagnostics() {
            const resultsDiv = document.getElementById('diagnostics-results');
            resultsDiv.innerHTML = '<div class="info">üîç Running comprehensive diagnostics...</div>';
            
            try {
                const response = await fetch('/.netlify/functions/test-email-config', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${adminPassword}` }
                });
                
                const result = await response.json();
                console.log('Diagnostics result:', result);
                
                let html = '';
                
                if (result.success && result.diagnostics) {
                    const diag = result.diagnostics;
                    
                    // Service Credentials Status
                    html += `<div class="${diag.credentials.available && diag.credentials.format === 'valid' ? 'success' : 'error'}">`;
                    html += `<strong>üîë Service Credentials Status:</strong><br>`;
                    html += `‚Ä¢ Available: ${diag.credentials.available}<br>`;
                    html += `‚Ä¢ Source: ${diag.credentials.source}<br>`;
                    html += `‚Ä¢ Length: ${diag.credentials.length}<br>`;
                    html += `‚Ä¢ Format: ${diag.credentials.format}<br>`;
                    if (diag.credentials.error) {
                        html += `‚Ä¢ Error: ${diag.credentials.error}<br>`;
                    }
                    html += '</div>';
                    
                    // Service Connection Test
                    html += `<div class="${diag.serviceConnection.success ? 'success' : 'error'}">`;
                    html += `<strong>üîó Email Service Test:</strong><br>`;
                    html += `‚Ä¢ Tested: ${diag.serviceConnection.tested}<br>`;
                    if (diag.serviceConnection.tested) {
                        html += `‚Ä¢ Status: ${diag.serviceConnection.status}<br>`;
                        html += `‚Ä¢ Success: ${diag.serviceConnection.success}<br>`;
                        if (diag.serviceConnection.error) {
                            html += `‚Ä¢ Error: ${diag.serviceConnection.error}<br>`;
                        }
                    }
                    html += '</div>';
                    
                    // Environment Info
                    html += '<div class="info">';
                    html += '<strong>‚öôÔ∏è Environment:</strong><br>';
                    html += `‚Ä¢ Database URL: ${diag.environment.hasNetlifyDbUrl ? 'Available' : 'Missing'}<br>`;
                    html += `‚Ä¢ Service Env Variable: ${diag.environment.hasSendGridKey ? 'Set' : 'Not Set'}<br>`;
                    html += `‚Ä¢ Admin Password: ${diag.environment.hasAdminPassword ? 'Set' : 'Not Set'}<br>`;
                    html += '</div>';
                    
                    // Email Config
                    html += '<div class="info">';
                    html += '<strong>üìß Email Configuration:</strong><br>';
                    html += `‚Ä¢ From: ${diag.emailConfig.senderEmail}<br>`;
                    html += `‚Ä¢ Name: ${diag.emailConfig.senderName}<br>`;
                    html += `‚Ä¢ Website: ${diag.emailConfig.websiteUrl}<br>`;
                    html += '</div>';
                    
                    // Raw diagnostics
                    html += '<div class="info">';
                    html += '<strong>üìä Full Diagnostics:</strong>';
                    html += '<pre>' + JSON.stringify(diag, null, 2) + '</pre>';
                    html += '</div>';
                    
                } else {
                    html = `<div class="error">‚ùå Diagnostics failed: ${result.error || 'Unknown error'}</div>`;
                    if (result.details) {
                        html += `<div class="error">Details: ${result.details}</div>`;
                    }
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Diagnostics error:', error);
                resultsDiv.innerHTML = `<div class="error">‚ùå Diagnostics network error: ${error.message}</div>`;
            }
        }
        
        // Test RSVP data
        async function testRSVPData() {
            const resultsDiv = document.getElementById('rsvp-results');
            resultsDiv.innerHTML = '<div class="info">üîç Checking RSVP data...</div>';
            
            try {
                const response = await fetch('/.netlify/functions/get-rsvps', {
                    headers: { 'Authorization': `Bearer ${adminPassword}` }
                });
                
                const result = await response.json();
                console.log('RSVP Data:', result);
                
                if (result.success && result.data) {
                    attendingGuests = result.data.filter(guest => guest.attendance === 'yes');
                    
                    let html = `<div class="success">‚úÖ Found ${result.data.length} total RSVPs, ${attendingGuests.length} attending</div>`;
                    
                    if (attendingGuests.length > 0) {
                        html += '<div class="info"><strong>Attending Guests:</strong><br>';
                        attendingGuests.forEach(guest => {
                            html += `‚Ä¢ ${guest.name} (${guest.email}) - ID: ${guest.id}<br>`;
                        });
                        html += '</div>';
                        
                        // Populate recipient selector
                        const selector = document.getElementById('real-recipients');
                        selector.innerHTML = '';
                        attendingGuests.forEach(guest => {
                            const option = document.createElement('option');
                            option.value = guest.id;
                            option.textContent = `${guest.name} (${guest.email})`;
                            selector.appendChild(option);
                        });
                    } else {
                        html += '<div class="error">‚ùå No attending guests found. Make sure someone has RSVP\'d as "yes".</div>';
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<div class="error">‚ùå Error fetching RSVPs: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('RSVP test error:', error);
                resultsDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Test email sending with manual email
        async function testEmailSending() {
            const email = document.getElementById('test-email').value;
            const subject = document.getElementById('test-subject').value;
            const message = document.getElementById('test-message').value;
            
            if (!email || !subject || !message) {
                alert('Please fill in all fields');
                return;
            }
            
            const resultsDiv = document.getElementById('email-results');
            resultsDiv.innerHTML = '<div class="info">üìß Sending test email...</div>';
            
            // First, create a temporary RSVP record for testing
            try {
                const testData = {
                    recipient_ids: [999999], // Use a fake ID that won't exist
                    subject: subject,
                    message: message,
                    notification_type: 'test'
                };
                
                console.log('Sending test notification:', testData);
                
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminPassword}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                console.log('Test email response:', result);
                
                let html = `<div class="${result.success ? 'success' : 'error'}">`;
                html += result.success ? '‚úÖ ' : '‚ùå ';
                html += result.message || result.error || 'Unknown response';
                html += '</div>';
                
                if (result.errors && result.errors.length > 0) {
                    html += '<div class="error"><strong>Errors:</strong><br>';
                    result.errors.forEach(error => {
                        html += `‚Ä¢ ${error}<br>`;
                    });
                    html += '</div>';
                }
                
                html += '<div class="info"><strong>Full Response:</strong><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Test email error:', error);
                resultsDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Test with real recipients
        async function testRealNotification() {
            const selectedOptions = Array.from(document.getElementById('real-recipients').selectedOptions);
            const subject = document.getElementById('real-subject').value;
            const message = document.getElementById('real-message').value;
            
            if (selectedOptions.length === 0) {
                alert('Please select at least one recipient');
                return;
            }
            
            if (!subject || !message) {
                alert('Please fill in subject and message');
                return;
            }
            
            const resultsDiv = document.getElementById('real-results');
            resultsDiv.innerHTML = '<div class="info">üìß Sending to selected recipients...</div>';
            
            try {
                const testData = {
                    recipient_ids: selectedOptions.map(option => parseInt(option.value)),
                    subject: subject,
                    message: message,
                    notification_type: 'test'
                };
                
                console.log('Sending real notification:', testData);
                
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminPassword}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                console.log('Real notification response:', result);
                
                let html = `<div class="${result.success ? 'success' : 'error'}">`;
                html += result.success ? '‚úÖ ' : '‚ùå ';
                html += result.message || result.error || 'Unknown response';
                html += '</div>';
                
                if (result.method) {
                    html += `<div class="info"><strong>Email Method:</strong> ${result.method}</div>`;
                }
                
                if (result.sentCount !== undefined && result.totalRecipients !== undefined) {
                    html += `<div class="info"><strong>Success Rate:</strong> ${result.sentCount}/${result.totalRecipients}</div>`;
                }
                
                if (result.errors && result.errors.length > 0) {
                    html += '<div class="error"><strong>Errors:</strong><br>';
                    result.errors.forEach(error => {
                        html += `‚Ä¢ ${error}<br>`;
                    });
                    html += '</div>';
                }
                
                html += '<div class="info"><strong>Full Response:</strong><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Real notification error:', error);
                resultsDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Raw API test
        async function testRawAPI() {
            const resultsDiv = document.getElementById('raw-results');
            resultsDiv.innerHTML = '<div class="info">‚ö° Testing raw API...</div>';
            
            try {
                // Test with minimal data
                const testData = {
                    recipient_ids: [1], // Try with ID 1
                    subject: 'Raw API Test',
                    message: 'This is a raw API test message.',
                    notification_type: 'test'
                };
                
                console.log('Raw API test data:', testData);
                
                const response = await fetch('/.netlify/functions/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminPassword}`
                    },
                    body: JSON.stringify(testData)
                });
                
                console.log('Raw API response status:', response.status);
                console.log('Raw API response headers:', Object.fromEntries(response.headers));
                
                const result = await response.json();
                console.log('Raw API response body:', result);
                
                let html = '<div class="info"><strong>Response Details:</strong><br>';
                html += `‚Ä¢ Status: ${response.status}<br>`;
                html += `‚Ä¢ Success: ${result.success}<br>`;
                html += `‚Ä¢ Message: ${result.message || 'None'}<br>`;
                html += `‚Ä¢ Error: ${result.error || 'None'}<br>`;
                html += '</div>';
                
                html += '<div class="info"><strong>Full Response:</strong><pre>' + JSON.stringify(result, null, 2) + '</pre></div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Raw API error:', error);
                resultsDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}<br>Stack: ${error.stack}</div>`;
            }
        }
        
        // Load diagnostics and RSVP data on page load
        window.addEventListener('load', async function() {
            await runDiagnostics();
            await testRSVPData();
        });
    </script>
</body>
</html>