<!DOCTYPE html>
<html>
<head>
    <title>HEIC Support Test</title>
</head>
<body>
    <h1>HEIC Support Test</h1>
    <input type="file" id="fileInput" accept="image/*">
    <div id="result"></div>
    
    <script>
        // Function to check if a file is HEIC format
        function isHeicFile(file) {
            // Check file extension
            const fileName = file.name.toLowerCase();
            const isHeicExtension = fileName.endsWith('.heic') || fileName.endsWith('.heif');
            
            // Check MIME type if available
            const isHeicMime = file.type === 'image/heic' || file.type === 'image/heif';
            
            return isHeicExtension || isHeicMime;
        }

        // Function to dynamically load heic2any library
        function loadHeic2anyLibrary() {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (typeof heic2any !== 'undefined') {
                    resolve();
                    return;
                }
                
                // Create script element
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load HEIC conversion library'));
                
                // Add to document
                document.head.appendChild(script);
            });
        }

        // Function to convert HEIC to JPEG using heic2any library
        async function convertHeicToJpeg(heicFile) {
            try {
                // Dynamically load heic2any library if not already loaded
                await loadHeic2anyLibrary();
                
                // Convert HEIC to JPEG using the library
                const jpegBlob = await heic2any({
                    blob: heicFile,
                    toType: 'image/jpeg',
                    quality: 0.92
                });
                
                // Create a new file with JPEG extension
                const jpegFile = new File([jpegBlob], heicFile.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                return jpegFile;
            } catch (error) {
                throw new Error('Failed to convert HEIC image: ' + error.message);
            }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<p>Selected file: ${file.name} (${file.type})</p>`;
            
            if (isHeicFile(file)) {
                resultDiv.innerHTML += '<p>Detected as HEIC file. Converting to JPEG...</p>';
                try {
                    const jpegFile = await convertHeicToJpeg(file);
                    resultDiv.innerHTML += `<p>Conversion successful! New file: ${jpegFile.name} (${jpegFile.type})</p>`;
                } catch (error) {
                    resultDiv.innerHTML += `<p>Conversion failed: ${error.message}</p>`;
                }
            } else {
                resultDiv.innerHTML += '<p>Not a HEIC file. No conversion needed.</p>';
            }
        });
    </script>
</body>
</html>