<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mary & Chima - RSVP Admin</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Georgia, serif;
      margin: 0;
      padding: 20px;
      background: #fafafa;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    .logout-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-info {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #c8a951;
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: #f0f0f0;
      color: #333;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .tab-btn.active {
      background: #c8a951;
      color: white;
    }
    .tab-btn:hover {
      background: #d4b963;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .btn-success {
      background: #4caf50;
      color: white;
    }
    .btn-info {
      background: #2196f3;
      color: white;
    }
    .btn-warning {
      background: #ff9800;
      color: white;
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .table-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .table-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .table-card.full {
      border-color: #f44336;
    }
    .table-card.optimal {
      border-color: #4caf50;
    }
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .guest-item {
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      margin: 4px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .guest-primary {
      background: #e8f5e8;
      font-weight: bold;
    }
    .unassigned-section {
      margin-top: 30px;
      padding: 20px;
      background: #fff3e0;
      border-radius: 12px;
    }
    .unassigned-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .draggable {
      cursor: move;
      transition: transform 0.2s;
      user-select: none;
    }
    .draggable:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .drop-zone {
      min-height: 40px;
      border: 2px dashed transparent;
      transition: all 0.3s ease;
    }
    .drop-zone.drag-over {
      border-color: #c8a951;
      background-color: #f9f7e8;
    }
    .guest-item.selected {
      background-color: #e3f2fd;
      border: 2px solid #2196f3;
      transform: scale(1.02);
    }
    .notification-composer {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
      padding: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .selected-item {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: #c8a951;
      color: white;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }
    .btn.active {
      background: #c8a951 !important;
      color: white !important;
      box-shadow: 0 2px 8px rgba(200, 169, 81, 0.3);
    }
    .rsvp-list {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .rsvp-item {
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .rsvp-item.selected-item {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      transform: translateX(4px);
    }
    
    .rsvp-item:not(.selected-item) {
      grid-template-columns: 1fr auto;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-right: 10px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      cursor: pointer;
      accent-color: #2196f3;
    }
    
    .checkbox-item label {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #2196f3;
      font-size: 12px;
    }
    .rsvp-item:last-child {
      border-bottom: none;
    }
    .rsvp-details h3 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .rsvp-details p {
      margin: 5px 0;
      color: #666;
      font-size: 0.9rem;
    }
    .attendance-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .attending {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .not-attending {
      background: #fff3e0;
      color: #f57c00;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    @media (max-width: 768px) {
      .rsvp-item {
        grid-template-columns: 1fr;
      }
      .controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <div>
          <h1>Mary & Chima Wedding</h1>
          <p>Complete Event Management Dashboard</p>
        </div>
        <div class="logout-section">
          <span class="admin-info">Admin Dashboard</span>
          <button class="btn btn-danger" onclick="logout()" title="Logout">üö™ Logout</button>
        </div>
      </div>
      
      <!-- Enhanced Dashboard Controls -->
      <div class="dashboard-controls">
        <button class="btn btn-info" onclick="toggleInsightsPanel()">üß† AI Insights</button>
        <button class="btn btn-success" onclick="toggleAutomationPanel()">‚ö° Automation</button>
        <button class="btn btn-secondary" onclick="toggleRealTimeUpdates()">üìä Live Updates</button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('rsvps')">RSVPs</button>
      <button class="tab-btn" onclick="switchTab('guests')">Individual Guests</button>
      <button class="tab-btn" onclick="switchTab('tables')">Table Management</button>
      <button class="tab-btn" onclick="switchTab('songs')">Song Requests</button>
      <button class="tab-btn" onclick="switchTab('photos')">Photo Shares</button>
      <button class="tab-btn" onclick="switchTab('wishes')">Wishes</button>
      <button class="tab-btn" onclick="switchTab('notifications')">Notifications</button>
    </div>

    <!-- RSVP Tab Content -->
    <div id="rsvps-content" class="tab-content active">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-responses">-</div>
          <div>Total Responses</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="attending">-</div>
          <div>Attending</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="not-attending">-</div>
          <div>Not Attending</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-guests">-</div>
          <div>Total Guests</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadRSVPs()">Refresh</button>
        <button class="btn btn-secondary" onclick="filterRSVPs('yes')">Show Attending</button>
        <button class="btn btn-secondary" onclick="filterRSVPs('no')">Show Not Attending</button>
        <button class="btn btn-secondary" onclick="filterRSVPs('')">Show All</button>
        <button class="btn btn-success" onclick="exportData('rsvps')">üìä Export RSVPs</button>
        <button class="btn btn-info" onclick="sendNotificationModal()">üìß Send Notification</button>
        <button class="btn btn-warning" onclick="toggleMultiSelect('rsvps')">‚úì Multi-Select</button>
        <button class="btn btn-danger" onclick="deleteSelected('rsvps')" style="display:none" id="delete-rsvps-btn">üóëÔ∏è Delete Selected</button>
        <a href="email-setup.html" target="_blank" class="btn" style="background: #9c27b0; color: white; text-decoration: none; display: inline-block;">‚öôÔ∏è Email Setup Guide</a>
        <div style="background: #e8f5e8; color: #2e7d2e; padding: 8px 12px; border-radius: 6px; display: inline-block; margin-left: 10px; font-size: 0.9rem; font-weight: bold;">
          ‚úÖ Email System Ready! No setup required.
        </div>
      </div>

      <div id="rsvp-error-container"></div>
      
      <!-- RSVP Notification Composer -->
      <!-- This notification composer is specific to the RSVP tab, allowing users to send notifications directly while viewing RSVPs -->
      <div class="notification-composer" style="display:none" id="rsvp-notification-composer">
        <h3>Send Notification to Attending Guests</h3>
        <form id="rsvp-notification-form">
          <div class="form-group">
            <label>Recipients:</label>
            <select id="rsvp-notification-recipients" multiple style="height: 120px;">
              <!-- Will be populated with attending guests -->
            </select>
          </div>
          <div class="form-group">
            <label>Subject:</label>
            <input type="text" name="subject" id="rsvp-notification-subject" placeholder="Wedding Update" required>
          </div>
          <div class="form-group">
            <label>Message:</label>
            <textarea name="message" id="rsvp-notification-message" rows="5" placeholder="Your message to guests..." required></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-primary">Send Notification</button>
            <button type="button" class="btn btn-secondary" onclick="hideRSVPNotificationComposer()">Cancel</button>
          </div>
        </form>
      </div>
      
      <div class="rsvp-list" id="rsvp-list">
        <div class="loading">Loading RSVPs...</div>
      </div>
    </div>

    <!-- Individual Guests Tab Content -->
    <div id="guests-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-individuals">-</div>
          <div>Total Individual Guests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="primary-guests">-</div>
          <div>Primary Guests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="additional-guests">-</div>
          <div>Additional Guests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="dietary-requirements">-</div>
          <div>Special Dietary Needs</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadIndividualGuests()">Refresh Guests</button>
        <button class="btn btn-secondary" onclick="filterGuests('primary')">Primary Guests</button>
        <button class="btn btn-secondary" onclick="filterGuests('additional')">Additional Guests</button>
        <button class="btn btn-secondary" onclick="filterGuests('dietary')">With Dietary Needs</button>
        <button class="btn btn-secondary" onclick="filterGuests('all')">All Guests</button>
        <button class="btn btn-success" onclick="exportData('guests')">üìä Export Guests</button>
        <button class="btn btn-warning" onclick="migrateIndividualGuests()">üîÑ Migrate Guest Records</button>
      </div>

      <div id="guests-error-container"></div>
      <div class="rsvp-list" id="guests-list">
        <div class="loading">Loading individual guests...</div>
      </div>
    </div>

    <!-- Table Management Tab Content -->
    <div id="tables-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-tables-count">-</div>
          <div>Total Tables</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="assigned-guests">-</div>
          <div>Assigned Guests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="unassigned-guests">-</div>
          <div>Unassigned Guests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="average-table-size">-</div>
          <div>Avg Table Size</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadTableData()">Refresh Tables</button>
        <button class="btn btn-secondary" onclick="showUnassigned()">Show Unassigned</button>
        <button class="btn btn-info" onclick="autoAssignTables()">ü§ñ Auto-Assign</button>
        <button class="btn btn-warning" onclick="unassignSelected()">‚ùå Unassign Selected</button>
        <button class="btn btn-success" onclick="exportData('tables')">üìä Export Seating Plan</button>
      </div>

      <div id="tables-error-container"></div>
      
      <!-- Table Assignment Interface -->
      <div class="table-assignment-section">
        <h3>Table Assignments</h3>
        <div id="table-grid" class="table-grid">
          <!-- Tables will be populated here -->
        </div>
        
        <div id="unassigned-section" class="unassigned-section">
          <h4>Unassigned Guests</h4>
          <div id="unassigned-list" class="unassigned-list">
            <!-- Unassigned guests will be listed here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Tab Content -->
    <div id="notifications-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="notification-count">-</div>
          <div>Total Notifications Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="notified-guests">-</div>
          <div>Notified Guests</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadNotifications()">Refresh</button>
        <button class="btn btn-success" onclick="sendBulkNotification()">üìß Send Bulk Notification</button>
        <button class="btn btn-success" onclick="exportData('notifications')">üìä Export Notifications</button>
        <button class="btn btn-warning" onclick="toggleMultiSelect('notifications')">‚úì Multi-Select</button>
        <button class="btn btn-danger" onclick="deleteSelected('notifications')" style="display:none" id="delete-notifications-btn">üóëÔ∏è Delete Selected</button>
      </div>

      <!-- Notification Composer -->
      <div class="notification-composer" style="display:none" id="notification-composer">
        <h3>Send Notification</h3>
        <form id="notification-form">
          <div class="form-group">
            <label>Recipients:</label>
            <select id="notification-recipients" multiple style="height: 120px;">
              <!-- Will be populated with attending guests -->
            </select>
          </div>
          <div class="form-group">
            <label>Subject:</label>
            <input type="text" name="subject" id="notification-subject" placeholder="Wedding Update" required>
          </div>
          <div class="form-group">
            <label>Message:</label>
            <textarea name="message" id="notification-message" rows="5" placeholder="Your message to guests..." required></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-primary">Send Notification</button>
            <button type="button" class="btn btn-secondary" onclick="hideNotificationComposer()">Cancel</button>
          </div>
        </form>
      </div>

      <div id="notifications-error-container"></div>
      <div class="rsvp-list" id="notifications-list">
        <div class="loading">Loading notifications...</div>
      </div>
    </div>

    <!-- Songs Tab Content -->
    <div id="songs-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-songs">-</div>
          <div>Total Song Requests</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="popular-genre">-</div>
          <div>Most Popular Genre</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadSongs()">Refresh Songs</button>
        <button class="btn btn-success" onclick="exportData('songs')">üìä Export Songs</button>
        <button class="btn btn-warning" onclick="toggleMultiSelect('songs')">‚úì Multi-Select</button>
        <button class="btn btn-danger" onclick="deleteSelected('songs')" style="display:none" id="delete-songs-btn">üóëÔ∏è Delete Selected</button>
      </div>

      <div id="songs-error-container"></div>
      <div class="rsvp-list" id="songs-list">
        <div class="loading">Loading song requests...</div>
      </div>
    </div>

    <!-- Photos Tab Content -->
    <div id="photos-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-photos">-</div>
          <div>Total Photos Shared</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="popular-category">-</div>
          <div>Most Popular Category</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadPhotos()">Refresh Photos</button>
        <button class="btn btn-secondary" onclick="filterPhotos('ceremony')">Ceremony</button>
        <button class="btn btn-secondary" onclick="filterPhotos('reception')">Reception</button>
        <button class="btn btn-secondary" onclick="filterPhotos('dancing')">Dancing</button>
        <button class="btn btn-secondary" onclick="filterPhotos('all')">All Categories</button>
        <button class="btn btn-success" onclick="exportData('photos')">üìä Export Photos</button>
        <button class="btn btn-warning" onclick="toggleMultiSelect('photos')">‚úì Multi-Select</button>
        <button class="btn btn-danger" onclick="deleteSelected('photos')" style="display:none" id="delete-photos-btn">üóëÔ∏è Delete Selected</button>
      </div>

      <div id="photos-error-container"></div>
      <div class="rsvp-list" id="photos-list">
        <div class="loading">Loading photo shares...</div>
      </div>
    </div>

    <!-- Wishes Tab Content -->
    <div id="wishes-content" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-wishes">-</div>
          <div>Total Wishes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="popular-message-type">-</div>
          <div>Most Common Type</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadWishes()">Refresh Wishes</button>
        <button class="btn btn-secondary" onclick="filterWishes('blessing')">Blessings</button>
        <button class="btn btn-secondary" onclick="filterWishes('prayer')">Prayers</button>
        <button class="btn btn-secondary" onclick="filterWishes('advice')">Advice</button>
        <button class="btn btn-secondary" onclick="filterWishes('all')">All Types</button>
        <button class="btn btn-success" onclick="exportData('wishes')">üìä Export Wishes</button>
        <button class="btn btn-warning" onclick="toggleMultiSelect('wishes')">‚úì Multi-Select</button>
        <button class="btn btn-danger" onclick="deleteSelected('wishes')" style="display:none" id="delete-wishes-btn">üóëÔ∏è Delete Selected</button>
      </div>

      <div id="wishes-error-container"></div>
      <div class="rsvp-list" id="wishes-list">
        <div class="loading">Loading wishes...</div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
      <h2 style="text-align: center; margin-bottom: 30px; color: #c8a951;">Admin Login</h2>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold;">Password:</label>
        <input type="password" id="login-password" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" placeholder="Enter admin password">
      </div>
      <div id="login-error" style="color: #f44336; margin-bottom: 20px; text-align: center; display: none;"></div>
      <div style="text-align: center;">
        <button onclick="attemptLogin()" style="background: #c8a951; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-right: 10px;">Login</button>
        <button onclick="window.location.href='index.html'" style="background: #f0f0f0; color: #333; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let currentFilter = '';
    let currentTab = 'rsvps';
    let multiSelectMode = {};
    let selectedItems = {};
    const adminPassword = 'Mary&Chima0003';
    let isAuthenticated = false;

    // Authentication functions
    function checkAuthentication() {
      const authToken = sessionStorage.getItem('adminAuth');
      const authTime = sessionStorage.getItem('adminAuthTime');
      const currentTime = new Date().getTime();
      
      // Check if token exists and is less than 4 hours old
      if (authToken === adminPassword && authTime && (currentTime - parseInt(authTime)) < 4 * 60 * 60 * 1000) {
        isAuthenticated = true;
        showDashboard();
      } else {
        // Clear expired session
        sessionStorage.removeItem('adminAuth');
        sessionStorage.removeItem('adminAuthTime');
        showLoginModal();
      }
    }

    function showLoginModal() {
      document.getElementById('login-modal').style.display = 'block';
      document.querySelector('.container').style.display = 'none';
      
      // Focus on password field
      setTimeout(() => {
        document.getElementById('login-password').focus();
      }, 100);
      
      // Handle Enter key
      document.getElementById('login-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          attemptLogin();
        }
      });
    }

    function showDashboard() {
      document.getElementById('login-modal').style.display = 'none';
      document.querySelector('.container').style.display = 'block';
      loadRSVPs(); // Load initial data
    }

    function attemptLogin() {
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (password === adminPassword) {
        // Store authentication in session
        sessionStorage.setItem('adminAuth', adminPassword);
        sessionStorage.setItem('adminAuthTime', new Date().getTime().toString());
        isAuthenticated = true;
        showDashboard();
      } else {
        errorDiv.textContent = 'Invalid password. Please try again.';
        errorDiv.style.display = 'block';
        document.getElementById('login-password').value = '';
        document.getElementById('login-password').focus();
      }
    }

    // Initialize authentication check on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
      initializeDragAndDrop();
      initializeEnhancedDashboard();
    });

    /**
     * Enhanced Dashboard with AI Features
     */
    let dashboardState = {
      autoRefresh: true,
      refreshInterval: 30000,
      insightsPanelOpen: false,
      automationPanelOpen: false
    };

    function initializeEnhancedDashboard() {
      createInsightsPanel();
      createAutomationPanel();
      if (dashboardState.autoRefresh) {
        initializeRealTimeUpdates();
      }
    }

    function createInsightsPanel() {
      if (document.getElementById('insights-panel')) return;
      
      const panel = document.createElement('div');
      panel.id = 'insights-panel';
      panel.style.cssText = `
        position: fixed; top: 0; right: -400px; width: 400px; height: 100vh;
        background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        transition: right 0.3s ease; z-index: 1000; overflow-y: auto; padding: 20px;
      `;
      
      panel.innerHTML = `
        <div class="panel-header">
          <h3>üß† AI Insights</h3>
          <button onclick="toggleInsightsPanel()" style="float: right; border: none; background: none; font-size: 18px; cursor: pointer;">‚úï</button>
        </div>
        <div id="predictions-content">Loading predictions...</div>
        <div id="recommendations-content">Analyzing data...</div>
        <div id="alerts-content">Checking for issues...</div>
      `;
      
      document.body.appendChild(panel);
    }

    function createAutomationPanel() {
      if (document.getElementById('automation-panel')) return;
      
      const panel = document.createElement('div');
      panel.id = 'automation-panel';
      panel.style.cssText = `
        position: fixed; top: 0; left: -350px; width: 350px; height: 100vh;
        background: white; box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        transition: left 0.3s ease; z-index: 1000; overflow-y: auto; padding: 20px;
      `;
      
      panel.innerHTML = `
        <div class="panel-header">
          <h3>‚ö° Automation Center</h3>
          <button onclick="toggleAutomationPanel()" style="float: right; border: none; background: none; font-size: 18px; cursor: pointer;">‚úï</button>
        </div>
        <div class="automation-section">
          <h4>üöÄ Quick Actions</h4>
          <button class="btn btn-info" onclick="runTableOptimization()" style="width: 100%; margin: 5px 0;">
            ü™ë Optimize Tables
          </button>
          <button class="btn btn-warning" onclick="sendSmartReminders()" style="width: 100%; margin: 5px 0;">
            üìß Smart Reminders
          </button>
          <button class="btn btn-success" onclick="generateReports()" style="width: 100%; margin: 5px 0;">
            üìä Generate Reports
          </button>
        </div>
      `;
      
      document.body.appendChild(panel);
    }

    function toggleInsightsPanel() {
      const panel = document.getElementById('insights-panel');
      if (!panel) {
        createInsightsPanel();
        return;
      }
      
      dashboardState.insightsPanelOpen = !dashboardState.insightsPanelOpen;
      panel.style.right = dashboardState.insightsPanelOpen ? '0px' : '-400px';
      
      if (dashboardState.insightsPanelOpen) {
        loadInsights();
      }
    }

    function toggleAutomationPanel() {
      const panel = document.getElementById('automation-panel');
      if (!panel) {
        createAutomationPanel();
        return;
      }
      
      dashboardState.automationPanelOpen = !dashboardState.automationPanelOpen;
      panel.style.left = dashboardState.automationPanelOpen ? '0px' : '-350px';
    }

    function toggleRealTimeUpdates() {
      dashboardState.autoRefresh = !dashboardState.autoRefresh;
      
      const button = event.target;
      if (dashboardState.autoRefresh) {
        button.innerHTML = 'üìä Live Updates (ON)';
        button.classList.add('active');
        initializeRealTimeUpdates();
        showNotification('‚úÖ Real-time updates enabled', 'success');
      } else {
        button.innerHTML = 'üìä Live Updates (OFF)';
        button.classList.remove('active');
        showNotification('üî¥ Real-time updates disabled', 'info');
      }
    }

    async function loadInsights() {
      try {
        const response = await fetch('/.netlify/functions/intelligent-automation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionStorage.getItem('adminAuth')}`
          },
          body: JSON.stringify({ action: 'guest_analytics' })
        });
        
        if (!response.ok) {
          throw new Error('Failed to load insights');
        }
        
        const data = await response.json();
        updateInsightsDisplay(data);
      } catch (error) {
        console.error('Failed to load insights:', error);
        document.getElementById('predictions-content').innerHTML = '‚ùå Failed to load insights';
      }
    }

    function updateInsightsDisplay(data) {
      const predictionsContent = document.getElementById('predictions-content');
      const recommendationsContent = document.getElementById('recommendations-content');
      const alertsContent = document.getElementById('alerts-content');
      
      if (predictionsContent && data.current_stats) {
        predictionsContent.innerHTML = `
          <div class="insight-card">
            <h5>üìä Response Analytics</h5>
            <p>Response Rate: ${data.current_stats.response_rate}%</p>
            <p>Attendance Rate: ${data.current_stats.attendance_rate}%</p>
            <p>Total Invited: ${data.current_stats.total_invited}</p>
          </div>
        `;
      }
      
      if (recommendationsContent && data.predictions) {
        recommendationsContent.innerHTML = `
          <div class="insight-card">
            <h5>üéØ Predictions</h5>
            <p>Expected Final Responses: ${data.predictions.predicted_final_responses}</p>
            <p>Expected Attendance: ${data.predictions.predicted_final_attendance}</p>
          </div>
        `;
      }
      
      if (alertsContent) {
        alertsContent.innerHTML = `
          <div class="insight-card">
            <h5>‚úÖ System Status</h5>
            <p>All systems operational</p>
            <p>Last updated: ${new Date().toLocaleTimeString()}</p>
          </div>
        `;
      }
    }

    // Enhanced automation functions
    async function runTableOptimization() {
      try {
        showNotification('üîÑ Optimizing table assignments...', 'info');
        
        const response = await fetch('/.netlify/functions/intelligent-automation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionStorage.getItem('adminAuth')}`
          },
          body: JSON.stringify({ action: 'auto_table_optimization' })
        });
        
        if (!response.ok) {
          throw new Error('Optimization failed');
        }
        
        const result = await response.json();
        showNotification(`‚úÖ Optimized ${result.data.guests_assigned} guest assignments`, 'success');
        
        if (document.querySelector('.tab-btn.active').textContent.includes('Table')) {
          loadTableData();
        }
      } catch (error) {
        showNotification('‚ùå Table optimization failed', 'error');
        console.error('Table optimization error:', error);
      }
    }

    async function sendSmartReminders() {
      try {
        showNotification('üìß Analyzing reminder needs...', 'info');
        
        const response = await fetch('/.netlify/functions/intelligent-automation', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionStorage.getItem('adminAuth')}`
          },
          body: JSON.stringify({ action: 'smart_reminders' })
        });
        
        if (!response.ok) {
          throw new Error('Smart reminders failed');
        }
        
        const result = await response.json();
        const actions = result.data.recommended_actions;
        
        if (actions.length === 0) {
          showNotification('‚úÖ No reminders needed at this time', 'success');
        } else {
          showNotification(`üì¨ Found ${actions.length} recommended actions`, 'info');
        }
      } catch (error) {
        showNotification('‚ùå Smart reminders analysis failed', 'error');
        console.error('Smart reminders error:', error);
      }
    }

    async function generateReports() {
      try {
        showNotification('üìä Generating comprehensive reports...', 'info');
        
        const reports = ['rsvps', 'guests', 'tables', 'songs', 'photos', 'wishes'];
        
        for (const report of reports) {
          await exportData(report);
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        showNotification('‚úÖ All reports generated successfully', 'success');
      } catch (error) {
        showNotification('‚ùå Report generation failed', 'error');
        console.error('Report generation error:', error);
      }
    }

    function initializeRealTimeUpdates() {
      if (dashboardState.autoRefresh && !dashboardState.refreshTimer) {
        dashboardState.refreshTimer = setInterval(() => {
          refreshDashboardData();
        }, dashboardState.refreshInterval);
      }
    }

    function refreshDashboardData() {
      if (!dashboardState.autoRefresh) return;
      
      const activeTab = document.querySelector('.tab-btn.active')?.textContent.toLowerCase();
      
      switch(activeTab) {
        case 'rsvps':
          loadRSVPs();
          break;
        case 'individual guests':
          loadIndividualGuests();
          break;
        case 'table management':
          loadTableData();
          break;
        case 'song requests':
          loadSongs();
          break;
        case 'photo shares':
          loadPhotos();
          break;
        case 'wishes':
          loadWishes();
          break;
        case 'notifications':
          loadNotifications();
          break;
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 15px; 
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'}; 
        color: white; border-radius: 8px; z-index: 2000; max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }

    // Authentication helper
    function requireAuth() {
      if (!isAuthenticated) {
        showLoginModal();
        return false;
      }
      return true;
    }

    // Tab Management
    function switchTab(tabName) {
      if (!requireAuth()) return;
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(tabName + '-content').classList.add('active');
      event.target.classList.add('active');
      currentTab = tabName;
      
      switch(tabName) {
        case 'rsvps': loadRSVPs(); break;
        case 'guests': loadIndividualGuests(); break;
        case 'tables': loadTableData(); break;
        case 'songs': loadSongs(); break;
        case 'photos': loadPhotos(); break;
        case 'wishes': loadWishes(); break;
        case 'notifications': loadNotifications(); break;
      }
    }

    // Logout functionality
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Clear authentication data
        sessionStorage.removeItem('adminAuth');
        sessionStorage.removeItem('adminAuthTime');
        localStorage.clear();
        isAuthenticated = false;
        
        // Show login modal again instead of redirecting
        showLoginModal();
      }
    }

    // Export functionality
    function exportData(type) {
      if (!requireAuth()) return;
      
      let filename;
      switch(type) {
        case 'guests':
          filename = `wedding_individual_guests_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        case 'tables':
          filename = `wedding_seating_plan_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        case 'rsvps':
          filename = `wedding_rsvps_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        case 'songs':
          filename = `wedding_songs_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        case 'photos':
          filename = `wedding_photos_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        case 'notifications':
          filename = `wedding_notifications_${new Date().toISOString().split('T')[0]}.csv`;
          break;
        default:
          filename = `wedding_${type}_${new Date().toISOString().split('T')[0]}.csv`;
      }
      
      const url = `/.netlify/functions/export-data?type=${type}&authorization=${encodeURIComponent('Bearer ' + adminPassword)}`;
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Multi-select and delete functionality
    function toggleMultiSelect(type) {
      if (!requireAuth()) return;
      
      multiSelectMode[type] = !multiSelectMode[type];
      selectedItems[type] = [];
      const deleteBtn = document.getElementById(`delete-${type}-btn`);
      if (deleteBtn) {
        deleteBtn.style.display = multiSelectMode[type] ? 'inline-block' : 'none';
        deleteBtn.textContent = `üóëÔ∏è Delete Selected (0)`;
      }
      
      // Reload the current data to show/hide checkboxes
      if (type === 'rsvps') {
        const currentData = JSON.parse(sessionStorage.getItem('currentRSVPs') || '[]');
        displayRSVPs(currentData);
      }
    }

    async function deleteSelected(type) {
      if (!requireAuth()) return;
      
      if (!selectedItems[type] || selectedItems[type].length === 0) {
        alert('Please select items to delete.');
        return;
      }
      
      const itemCount = selectedItems[type].length;
      if (!confirm(`Are you sure you want to delete ${itemCount} ${type} entries? This cannot be undone.`)) {
        return;
      }

      // Show loading state
      const deleteBtn = document.getElementById(`delete-${type}-btn`);
      const originalText = deleteBtn.textContent;
      deleteBtn.textContent = `üóëÔ∏è Deleting ${itemCount} items...`;
      deleteBtn.disabled = true;

      try {
        console.log('Deleting entries:', { type, ids: selectedItems[type] });
        
        const response = await fetch('/.netlify/functions/delete-entries', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ type: type, ids: selectedItems[type] })
        });
        
        console.log('Delete response status:', response.status);
        const result = await response.json();
        console.log('Delete response:', result);
        
        if (response.ok && result.success) {
          // Success feedback
          alert(`‚úÖ Successfully deleted ${result.deletedCount} ${type} entries!`);
          
          // Reset multi-select state
          selectedItems[type] = [];
          multiSelectMode[type] = false;
          deleteBtn.style.display = 'none';
          
          // Reload the current data
          if (type === 'rsvps') {
            loadRSVPs();
          } else if (type === 'songs') {
            loadSongs();
          } else if (type === 'photos') {
            loadPhotos();
          } else if (type === 'wishes') {
            loadWishes();
          }
          
        } else {
          // Handle API error responses
          const errorMsg = result.error || 'Unknown error occurred';
          console.error('Delete API Error:', result);
          alert(`‚ùå Failed to delete entries: ${errorMsg}`);
        }
        
      } catch (error) {
        // Handle network errors
        console.error('Delete Network Error:', error);
        alert(`‚ùå Network error while deleting entries: ${error.message}`);
        
      } finally {
        // Reset button state
        deleteBtn.textContent = originalText;
        deleteBtn.disabled = false;
      }
    }

    // Notification functions
    function sendNotificationModal() {
      if (!requireAuth()) return;
      
      document.getElementById('rsvp-notification-composer').style.display = 'block';
      loadAttendingGuestsForRSVP();
    }

    function hideNotificationComposer() {
      document.getElementById('notification-composer').style.display = 'none';
    }
    
    function hideRSVPNotificationComposer() {
      document.getElementById('rsvp-notification-composer').style.display = 'none';
      // Clean up any helper messages
      const composer = document.getElementById('rsvp-notification-composer');
      const helperMessages = composer.querySelectorAll('div[style*="background: #e8f5e8"]');
      helperMessages.forEach(msg => msg.remove());
    }

    async function loadAttendingGuests() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-rsvps?attendance=yes', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        const select = document.getElementById('notification-recipients');
        select.innerHTML = result.data.map(rsvp => 
          `<option value="${rsvp.id}">${rsvp.name} (${rsvp.email})</option>`
        ).join('');
      } catch (error) {
        console.error('Error loading guests:', error);
      }
    }
    
    async function loadAttendingGuestsForRSVP() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-rsvps?attendance=yes', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        const select = document.getElementById('rsvp-notification-recipients');
        if (result.success && result.data) {
          select.innerHTML = result.data.map(rsvp => 
            `<option value="${rsvp.id}" selected>${rsvp.name} (${rsvp.email})</option>`
          ).join('');
          
          // Show helpful message
          if (result.data.length > 0) {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'background: #e8f5e8; border: 1px solid #4caf50; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 12px; color: #2e7d2e;';
            messageDiv.innerHTML = `‚úÖ All ${result.data.length} attending guests are pre-selected. Uncheck any you don't want to notify.`;
            select.parentNode.insertBefore(messageDiv, select.nextSibling);
          }
        } else {
          select.innerHTML = '<option disabled>No attending guests found</option>';
        }
      } catch (error) {
        console.error('Error loading guests for RSVP notification:', error);
        const select = document.getElementById('rsvp-notification-recipients');
        select.innerHTML = '<option disabled>Error loading guests</option>';
      }
    }

    // Data Loading Functions with Authentication
    async function loadRSVPs(filter = '') {
      if (!requireAuth()) return;
      
      try {
        let url = '/.netlify/functions/get-rsvps';
        if (filter && filter !== '') {
          url += `?attendance=${filter}`;
        }
        
        console.log('Loading RSVPs from:', url);
        console.log('Using admin password:', adminPassword.substring(0, 10) + '...');
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);
        
        if (result.success) {
          // Update stats using the statistics from the response
          document.getElementById('total-responses').textContent = result.statistics?.total_responses || result.data.length;
          document.getElementById('attending').textContent = result.statistics?.attending || result.data.filter(r => r.attendance === 'yes').length;
          document.getElementById('not-attending').textContent = result.statistics?.not_attending || result.data.filter(r => r.attendance === 'no').length;
          document.getElementById('total-guests').textContent = result.statistics?.total_guests || result.data.reduce((sum, r) => sum + (r.guest_count || 1), 0);
          
          // Display RSVP list
          displayRSVPs(result.data);
        } else {
          const errorMsg = result.error || 'Unknown error loading RSVPs';
          console.error('RSVP Loading Error:', result);
          document.getElementById('rsvp-list').innerHTML = `
            <div class="error" style="padding: 20px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; margin: 10px 0;">
              <h4 style="color: #d32f2f; margin: 0 0 10px 0;">‚ùå Error Loading RSVPs</h4>
              <p style="margin: 5px 0;"><strong>Error:</strong> ${errorMsg}</p>
              ${result.details ? `<p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Details:</strong> ${result.details.message || JSON.stringify(result.details)}</p>` : ''}
              <div style="margin-top: 15px;">
                <button onclick="runMigration()" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">üîß Run Database Migration</button>
                <button onclick="loadRSVPs()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Retry</button>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading RSVPs:', error);
        document.getElementById('rsvp-list').innerHTML = `
          <div class="error" style="padding: 20px; background: #ffebee; border: 1px solid #f44336; border-radius: 8px; margin: 10px 0;">
            <h4 style="color: #d32f2f; margin: 0 0 10px 0;">üåê Network Error</h4>
            <p style="margin: 5px 0;"><strong>Error:</strong> ${error.message}</p>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">This could be a network issue or server problem.</p>
            <div style="margin-top: 15px;">
              <button onclick="loadRSVPs()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üîÑ Retry</button>
            </div>
          </div>
        `;
      }
    }

    // Database migration function
    async function runMigration() {
      if (!requireAuth()) return;
      
      if (!confirm('Run database migration? This will update the database schema to fix any issues.')) {
        return;
      }
      
      const migrationBtn = event.target;
      const originalText = migrationBtn.textContent;
      migrationBtn.textContent = 'üîß Running Migration...';
      migrationBtn.disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/migrate-rsvp-schema', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        const result = await response.json();
        console.log('Migration result:', result);
        
        if (result.success) {
          alert('‚úÖ Database migration completed successfully!');
          // Reload RSVPs after successful migration
          loadRSVPs();
        } else {
          alert('‚ùå Migration failed: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Migration error:', error);
        alert('‚ùå Migration failed: ' + error.message);
      } finally {
        migrationBtn.textContent = originalText;
        migrationBtn.disabled = false;
      }
    }

    // Filter RSVPs function
    function filterRSVPs(attendance) {
      loadRSVPs(attendance);
      
      // Update button states
      const buttons = document.querySelectorAll('#rsvps-content .controls .btn--secondary');
      buttons.forEach(btn => btn.style.backgroundColor = '#f0f0f0');
      buttons.forEach(btn => btn.style.color = '#333');
      
      // Highlight active button
      if (attendance === 'yes' && buttons[0]) {
        buttons[0].style.backgroundColor = '#c8a951';
        buttons[0].style.color = 'white';
      } else if (attendance === 'no' && buttons[1]) {
        buttons[1].style.backgroundColor = '#c8a951';
        buttons[1].style.color = 'white';
      } else if (attendance === '' && buttons[2]) {
        buttons[2].style.backgroundColor = '#c8a951';
        buttons[2].style.color = 'white';
      }
    }

    function displayRSVPs(rsvps) {
      const container = document.getElementById('rsvp-list');
      if (rsvps.length === 0) {
        container.innerHTML = '<div class="loading">No RSVPs found</div>';
        return;
      }
      
      // Store current RSVP data for multi-select toggling
      sessionStorage.setItem('currentRSVPs', JSON.stringify(rsvps));
      
      container.innerHTML = rsvps.map(rsvp => `
        <div class="rsvp-item" data-id="${rsvp.id}">
          ${multiSelectMode['rsvps'] ? `<div class="checkbox-item">
            <input type="checkbox" id="rsvp-${rsvp.id}" onchange="toggleSelection('rsvps', ${rsvp.id})">
            <label for="rsvp-${rsvp.id}"></label>
          </div>` : ''}
          <div class="rsvp-details">
            <h3>${rsvp.name}</h3>
            <p><strong>Email:</strong> ${rsvp.email}</p>
            <p><strong>Phone:</strong> ${rsvp.phone || 'Not provided'}</p>
            <p><strong>Party Size:</strong> ${rsvp.guest_count || 1}</p>
            <p><strong>Additional Guests:</strong> ${rsvp.guest_names || 'None'}</p>
            <p><strong>Dietary:</strong> ${rsvp.dietary_requirements || 'None'}</p>
            <p><strong>Submitted:</strong> ${new Date(rsvp.created_at).toLocaleDateString()}</p>
          </div>
          <div>
            <span class="attendance-badge ${rsvp.attendance === 'yes' ? 'attending' : 'not-attending'}">
              ${rsvp.attendance === 'yes' ? 'Attending' : 'Not Attending'}
            </span>
          </div>
        </div>
      `).join('');
    }

    // Selection toggle function
    function toggleSelection(type, id) {
      if (!selectedItems[type]) selectedItems[type] = [];
      
      const index = selectedItems[type].indexOf(id);
      if (index > -1) {
        selectedItems[type].splice(index, 1);
      } else {
        selectedItems[type].push(id);
      }
      
      // Update UI feedback
      const item = document.querySelector(`[data-id="${id}"]`);
      if (item) {
        if (selectedItems[type].includes(id)) {
          item.classList.add('selected-item');
        } else {
          item.classList.remove('selected-item');
        }
      }
      
      // Update delete button
      const deleteBtn = document.getElementById(`delete-${type}-btn`);
      if (deleteBtn) {
        deleteBtn.textContent = `üóëÔ∏è Delete Selected (${selectedItems[type].length})`;
      }
    }

    async function loadIndividualGuests() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-individual-guests', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          // Update stats
          document.getElementById('total-individuals').textContent = result.statistics?.total_individuals || result.data.length;
          document.getElementById('primary-guests').textContent = result.statistics?.primary_guests || result.data.filter(g => g.is_primary).length;
          document.getElementById('additional-guests').textContent = result.statistics?.additional_guests || result.data.filter(g => !g.is_primary).length;
          document.getElementById('dietary-requirements').textContent = result.statistics?.dietary_requirements || result.data.filter(g => g.dietary_needs && g.dietary_needs.trim()).length;
          
          // Display guests list
          displayGuests(result.data);
        } else {
          document.getElementById('guests-list').innerHTML = `
            <div class="error">
              <h4>‚ùå Error Loading Individual Guests</h4>
              <p>${result.error || 'Unknown error occurred'}</p>
              <button onclick="migrateIndividualGuests()" class="btn btn-warning">üîÑ Run Migration</button>
              <button onclick="loadIndividualGuests()" class="btn btn-primary">üîÑ Retry</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading guests:', error);
        document.getElementById('guests-list').innerHTML = `
          <div class="error">
            <h4>‚ùå Network Error</h4>
            <p>Failed to load individual guests: ${error.message}</p>
            <button onclick="migrateIndividualGuests()" class="btn btn-warning">üîÑ Run Migration</button>
            <button onclick="loadIndividualGuests()" class="btn btn-primary">üîÑ Retry</button>
          </div>
        `;
      }
    }

    async function migrateIndividualGuests() {
      if (!requireAuth()) return;
      
      if (!confirm('This will create individual guest records from existing RSVPs. This is safe to run multiple times. Continue?')) {
        return;
      }
      
      try {
        // Show loading state
        document.getElementById('guests-list').innerHTML = '<div class="loading">üîÑ Running migration... Please wait.</div>';
        
        const response = await fetch('/.netlify/functions/migrate-individual-guests', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ Migration completed successfully!\n\n` +
                `RSVPs processed: ${result.statistics.rsvps_processed}\n` +
                `RSVPs migrated: ${result.statistics.rsvps_migrated}\n` +
                `RSVPs skipped: ${result.statistics.rsvps_skipped}\n\n` +
                `Total individual guests: ${result.statistics.total_individual_guests}\n` +
                `Primary guests: ${result.statistics.primary_guests}\n` +
                `Additional guests: ${result.statistics.additional_guests}`);
          
          // Reload the guests list
          loadIndividualGuests();
        } else {
          alert(`‚ùå Migration failed: ${result.error}`);
          document.getElementById('guests-list').innerHTML = `
            <div class="error">
              <h4>‚ùå Migration Failed</h4>
              <p>${result.error}</p>
              <button onclick="migrateIndividualGuests()" class="btn btn-warning">üîÑ Retry Migration</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Migration error:', error);
        alert(`‚ùå Migration failed: ${error.message}`);
        document.getElementById('guests-list').innerHTML = `
          <div class="error">
            <h4>‚ùå Migration Error</h4>
            <p>${error.message}</p>
            <button onclick="migrateIndividualGuests()" class="btn btn-warning">üîÑ Retry Migration</button>
          </div>
        `;
      }
    }

    function displayGuests(guests) {
      const container = document.getElementById('guests-list');
      if (guests.length === 0) {
        container.innerHTML = '<div class="loading">No individual guests found</div>';
        return;
      }
      
      container.innerHTML = guests.map(guest => `
        <div class="rsvp-item">
          <div class="rsvp-details">
            <h3>${guest.guest_name} ${guest.is_primary ? '(Primary Guest)' : '(Additional Guest)'}</h3>
            <p><strong>RSVP by:</strong> ${guest.rsvp_name || 'Unknown'} (${guest.rsvp_email || 'No email'})</p>
            <p><strong>Attendance Status:</strong> <span class="attendance-badge ${guest.attendance}">${guest.attendance === 'yes' ? 'Attending' : 'Not Attending'}</span></p>
            <p><strong>Dietary Requirements:</strong> ${guest.dietary_needs || 'None specified'}</p>
            <p><strong>Table Assignment:</strong> ${guest.table_number ? `Table ${guest.table_number}` : 'Unassigned'}</p>
            <p><strong>RSVP ID:</strong> ${guest.rsvp_id}</p>
            <p><strong>Guest Type:</strong> ${guest.is_primary ? 'Primary Contact' : 'Additional Guest'}</p>
          </div>
        </div>
      `).join('');
    }

    async function filterGuests(filterType) {
      if (!requireAuth()) return;
      
      try {
        let url = '/.netlify/functions/get-individual-guests';
        if (filterType && filterType !== 'all') {
          url += `?filter_type=${filterType}`;
        }
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          displayGuests(result.data);
          
          // Update filter buttons
          document.querySelectorAll('#guests-content .controls .btn-secondary').forEach(btn => {
            btn.classList.remove('active');
          });
          event.target.classList.add('active');
        } else {
          document.getElementById('guests-list').innerHTML = '<div class="error">Error filtering guests</div>';
        }
      } catch (error) {
        console.error('Error filtering guests:', error);
        document.getElementById('guests-list').innerHTML = '<div class="error">Error filtering guests</div>';
      }
    }

    async function loadTableData() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-table-data', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          // Update stats with correct field names
          const stats = result.data.statistics;
          document.getElementById('total-tables-count').textContent = stats.total_tables || 0;
          document.getElementById('assigned-guests').textContent = stats.total_assigned || 0;
          document.getElementById('unassigned-guests').textContent = stats.total_unassigned || 0;
          
          // Calculate average table size
          const avgSize = stats.total_tables > 0 ? Math.round(stats.total_assigned / stats.total_tables) : 0;
          document.getElementById('average-table-size').textContent = avgSize;
          
          // Display tables and unassigned guests
          displayTables(result.data);
          displayUnassignedGuests(result.data.unassigned_guests || []);
        } else {
          document.getElementById('table-grid').innerHTML = `
            <div class="error">
              <h4>‚ùå Error Loading Table Data</h4>
              <p>${result.error || 'Unknown error occurred'}</p>
              <button onclick="loadTableData()" class="btn btn-primary">üîÑ Retry</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading table data:', error);
        document.getElementById('table-grid').innerHTML = `
          <div class="error">
            <h4>‚ùå Network Error</h4>
            <p>Failed to load table data: ${error.message}</p>
            <button onclick="loadTableData()" class="btn btn-primary">üîÑ Retry</button>
          </div>
        `;
      }
    }

    function displayTables(tableData) {
      const container = document.getElementById('table-grid');
      
      if (!tableData.tables || tableData.tables.length === 0) {
        container.innerHTML = '<div class="loading">No tables assigned yet. Use "Show Unassigned" to see guests needing table assignments.</div>';
        return;
      }
      
      container.innerHTML = tableData.tables.map(table => {
        const guestCount = table.total_guests || table.guests.length;
        const capacity = 4; // Changed to 4 guests per table for 50 total guests
        const isOverCapacity = guestCount > capacity;
        const isOptimal = guestCount === capacity;
        
        return `
          <div class="table-card drop-zone ${isOverCapacity ? 'full' : isOptimal ? 'optimal' : ''}">
            <div class="table-header">
              <span>Table ${table.table_number}</span>
              <span>${guestCount}/${capacity} guests</span>
            </div>
            <div class="table-guests">
              ${table.guests.map(guest => `
                <div class="guest-item draggable ${guest.is_primary ? 'guest-primary' : ''}" 
                     data-guest-id="${guest.guest_id}" 
                     draggable="true"
                     onclick="toggleGuestSelection(this)"
                     title="Click to select, drag to move to different table">
                  <span>${guest.name}</span>
                  ${guest.dietary_needs ? '<small style="color: #666;">ü•ó Special diet</small>' : ''}
                </div>
              `).join('')}}
              ${guestCount < capacity ? `<div class="drop-hint" style="padding: 8px; text-align: center; color: #999; font-size: 12px; border: 1px dashed #ddd; margin: 4px 0; border-radius: 4px;">Drop guests here (${capacity - guestCount} spaces left)</div>` : ''}
            </div>
            ${table.dietary_requirements && table.dietary_requirements.length > 0 ? `
              <div class="table-dietary" style="margin-top: 8px; padding: 4px; background: #fff3e0; border-radius: 4px; font-size: 12px;">
                <strong>Dietary:</strong> ${[...new Set(table.dietary_requirements)].join(', ')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      // Re-initialize drag and drop for new elements
      setTimeout(initializeDragAndDrop, 100);
    }
    
    function displayUnassignedGuests(unassignedGuests) {
      const unassignedList = document.getElementById('unassigned-list');
      
      if (!unassignedGuests || unassignedGuests.length === 0) {
        unassignedList.innerHTML = '<div class="loading">‚úÖ All guests are assigned to tables!</div>';
        return;
      }
      
      unassignedList.innerHTML = unassignedGuests.map(guest => `
        <div class="guest-item draggable" 
             data-guest-id="${guest.guest_id}" 
             data-rsvp-id="${guest.rsvp_id}"
             draggable="true"
             title="Drag to assign to a table">
          <div>
            <strong>${guest.name}</strong> ${guest.is_primary ? '(Primary)' : '(Additional)'}
            ${guest.email ? `<br><small>${guest.email}</small>` : ''}
            ${guest.dietary_needs ? `<br><small style="color: #666;">ü•ó ${guest.dietary_needs}</small>` : ''}
          </div>
        </div>
      `).join('');
      
      // Re-initialize drag and drop for new elements
      setTimeout(initializeDragAndDrop, 100);
    }

    async function loadSongs() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-songs', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('total-songs').textContent = result.data.length;
          document.getElementById('popular-genre').textContent = result.statistics?.most_popular_genre || 'N/A';
          displaySongs(result.data);
        }
      } catch (error) {
        console.error('Error loading songs:', error);
        document.getElementById('songs-list').innerHTML = '<div class="error">Error loading songs</div>';
      }
    }

    function displaySongs(songs) {
      const container = document.getElementById('songs-list');
      if (songs.length === 0) {
        container.innerHTML = '<div class="loading">No song requests yet</div>';
        return;
      }
      
      container.innerHTML = songs.map(song => `
        <div class="rsvp-item" data-item-id="${song.id}">
          ${multiSelectMode.songs ? `
            <div class="checkbox-item">
              <input type="checkbox" id="song-${song.id}" onchange="updateSelectedCount('songs')">
              <label for="song-${song.id}">Select</label>
            </div>
          ` : ''}
          <div class="rsvp-details">
            <h3>${song.song_title}</h3>
            <p><strong>Artist:</strong> ${song.artist_name}</p>
            <p><strong>Genre:</strong> ${song.genre || 'Not specified'}</p>
            <p><strong>Requested by:</strong> ${song.name} (${song.email})</p>
            <p><strong>Date:</strong> ${new Date(song.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }

    async function loadPhotos() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-photos', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('total-photos').textContent = result.data.length;
          document.getElementById('popular-category').textContent = result.statistics?.category_breakdown?.[0]?.category || 'N/A';
          displayPhotos(result.data);
        }
      } catch (error) {
        console.error('Error loading photos:', error);
        document.getElementById('photos-list').innerHTML = '<div class="error">Error loading photos</div>';
      }
    }

    function displayPhotos(photos) {
      const container = document.getElementById('photos-list');
      if (photos.length === 0) {
        container.innerHTML = '<div class="loading">No photos shared yet</div>';
        return;
      }
      
      container.innerHTML = photos.map(photo => `
        <div class="rsvp-item" data-item-id="${photo.id}">
          ${multiSelectMode.photos ? `
            <div class="checkbox-item">
              <input type="checkbox" id="photo-${photo.id}" onchange="updateSelectedCount('photos')">
              <label for="photo-${photo.id}">Select</label>
            </div>
          ` : ''}
          <div class="rsvp-details">
            <h3>${photo.name}</h3>
            <p><strong>Email:</strong> ${photo.email}</p>
            <p><strong>Category:</strong> ${photo.category}</p>
            <p><strong>Description:</strong> ${photo.description || 'No description'}</p>
            <p><strong>URL:</strong> <a href="${photo.photo_url}" target="_blank">View Photo</a></p>
            <p><strong>Date:</strong> ${new Date(photo.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }

    function displayWishes(wishes) {
      const container = document.getElementById('wishes-list');
      if (wishes.length === 0) {
        container.innerHTML = '<div class="loading">No wishes yet</div>';
        return;
      }
      
      container.innerHTML = wishes.map(wish => `
        <div class="rsvp-item" data-item-id="${wish.id}">
          ${multiSelectMode.wishes ? `
            <div class="checkbox-item">
              <input type="checkbox" id="wish-${wish.id}" onchange="updateSelectedCount('wishes')">
              <label for="wish-${wish.id}">Select</label>
            </div>
          ` : ''}
          <div class="rsvp-details">
            <h3>${wish.name}</h3>
            <p><strong>Email:</strong> ${wish.email}</p>
            <p><strong>Type:</strong> ${wish.message_type}</p>
            <p><strong>Relationship:</strong> ${wish.relationship || 'Not specified'}</p>
            <p><strong>Message:</strong> ${wish.message}</p>
            <p><strong>Date:</strong> ${new Date(wish.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }

    function displayWishes(wishes) {
      const container = document.getElementById('wishes-list');
      if (wishes.length === 0) {
        container.innerHTML = '<div class="loading">No wishes submitted yet</div>';
        return;
      }
      
      container.innerHTML = wishes.map(wish => `
        <div class="rsvp-item" data-item-id="${wish.id}">
          ${multiSelectMode.wishes ? `
            <div class="checkbox-item">
              <input type="checkbox" id="wish-${wish.id}" onchange="updateSelectedCount('wishes')">
              <label for="wish-${wish.id}">Select</label>
            </div>
          ` : ''}
          <div class="rsvp-details">
            <h3>${wish.name}</h3>
            <p><strong>Email:</strong> ${wish.email}</p>
            <p><strong>Type:</strong> ${wish.message_type}</p>
            <p><strong>Message:</strong> ${wish.message}</p>
            <p><strong>Date:</strong> ${new Date(wish.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }

    async function loadNotifications() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-notifications', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          // Update stats
          document.getElementById('notification-count').textContent = result.statistics?.total_notifications || result.data.length;
          document.getElementById('notified-guests').textContent = result.statistics?.total_recipients || 0;
          
          // Display notifications list
          displayNotifications(result.data);
        } else {
          document.getElementById('notifications-list').innerHTML = '<div class="error">Error loading notifications</div>';
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notifications-list').innerHTML = '<div class="error">Error loading notifications</div>';
      }
    }
    
    function displayNotifications(notifications) {
      const container = document.getElementById('notifications-list');
      if (notifications.length === 0) {
        container.innerHTML = '<div class="loading">No notifications sent yet</div>';
        return;
      }
      
      container.innerHTML = notifications.map(notification => `
        <div class="rsvp-item" data-item-id="${notification.id}">
          ${multiSelectMode.notifications ? `
            <div class="checkbox-item">
              <input type="checkbox" id="notification-${notification.id}" onchange="updateSelectedCount('notifications')">
              <label for="notification-${notification.id}">Select</label>
            </div>
          ` : ''}
          <div class="rsvp-details">
            <h3>${notification.subject}</h3>
            <p><strong>Message:</strong> ${notification.message}</p>
            <p><strong>Type:</strong> ${notification.notification_type}</p>
            <p><strong>Recipients:</strong> ${notification.recipient_count}</p>
            <p><strong>Success Rate:</strong> ${notification.sent_count}/${notification.recipient_count} sent</p>
            <p><strong>Status:</strong> <span class="attendance-badge ${notification.status}">${notification.status}</span></p>
            <p><strong>Date:</strong> ${new Date(notification.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      `).join('');
    }
    
    async function loadWishes() {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/get-wishes', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('total-wishes').textContent = result.statistics?.total_wishes || result.data.length;
          document.getElementById('popular-message-type').textContent = result.statistics?.type_breakdown?.[0]?.message_type || 'N/A';
          displayWishes(result.data);
        } else {
          document.getElementById('wishes-list').innerHTML = '<div class="error">Error loading wishes</div>';
        }
      } catch (error) {
        console.error('Error loading wishes:', error);
        document.getElementById('wishes-list').innerHTML = '<div class="error">Error loading wishes</div>';
      }
    }
    
    async function filterPhotos(category) {
      if (!requireAuth()) return;
      
      try {
        let url = '/.netlify/functions/get-photos?admin_only=true';
        if (category && category !== 'all') {
          url += `&category=${category}`;
        }
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          displayPhotos(result.data);
        } else {
          document.getElementById('photos-list').innerHTML = '<div class="error">Error filtering photos</div>';
        }
      } catch (error) {
        console.error('Error filtering photos:', error);
        document.getElementById('photos-list').innerHTML = '<div class="error">Error filtering photos</div>';
      }
    }
    
    async function filterWishes(messageType) {
      if (!requireAuth()) return;
      
      try {
        let url = '/.netlify/functions/get-wishes';
        if (messageType && messageType !== 'all') {
          url += `?message_type=${messageType}`;
        }
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (result.success) {
          displayWishes(result.data);
        } else {
          document.getElementById('wishes-list').innerHTML = '<div class="error">Error filtering wishes</div>';
        }
      } catch (error) {
        console.error('Error filtering wishes:', error);
        document.getElementById('wishes-list').innerHTML = '<div class="error">Error filtering wishes</div>';
      }
    }
    
    // Update selected count for multi-select
    function updateSelectedCount(type) {
      if (!multiSelectMode[type]) return;
      
      const checkedBoxes = document.querySelectorAll(`#${type}-content input[type="checkbox"]:checked`);
      selectedItems[type] = Array.from(checkedBoxes).map(cb => {
        const itemElement = cb.closest('[data-item-id]');
        return itemElement ? parseInt(itemElement.dataset.itemId) : null;
      }).filter(id => id !== null);
      
      const deleteBtn = document.getElementById(`delete-${type}-btn`);
      if (deleteBtn) {
        deleteBtn.textContent = `üóëÔ∏è Delete Selected (${selectedItems[type].length})`;
      }
    }
    
    // Guest selection for table management
    let selectedGuests = [];
    
    function toggleGuestSelection(guestElement) {
      const guestId = parseInt(guestElement.dataset.guestId);
      
      if (guestElement.classList.contains('selected')) {
        guestElement.classList.remove('selected');
        selectedGuests = selectedGuests.filter(id => id !== guestId);
      } else {
        guestElement.classList.add('selected');
        selectedGuests.push(guestId);
      }
      
      // Update unassign button text
      const unassignBtn = document.querySelector('button[onclick="unassignSelected()"]');
      if (unassignBtn) {
        unassignBtn.textContent = selectedGuests.length > 0 
          ? `‚ùå Unassign Selected (${selectedGuests.length})`
          : '‚ùå Unassign Selected';
      }
    }
    
    async function unassignSelected() {
      if (!requireAuth()) return;
      
      if (selectedGuests.length === 0) {
        alert('Please select guests to unassign by clicking on them.');
        return;
      }
      
      if (!confirm(`Are you sure you want to unassign ${selectedGuests.length} guest(s) from their tables?`)) {
        return;
      }
      
      try {
        const assignments = selectedGuests.map(guestId => ({
          guest_id: guestId,
          table_number: null // null = unassigned
        }));
        
        const response = await fetch('/.netlify/functions/update-table-assignments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ assignments })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ Successfully unassigned ${result.updated_count} guests!`);
          selectedGuests = []; // Clear selection
          loadTableData(); // Refresh the table display
        } else {
          alert(`‚ùå Unassignment failed: ${result.error}`);
        }
        
      } catch (error) {
        console.error('Error unassigning guests:', error);
        alert('Error unassigning guests. Please try again.');
      }
    }
    
    // Notification sending functionality
    async function sendNotification() {
      if (!requireAuth()) return;
      
      const form = document.getElementById('notification-form');
      const formData = new FormData(form);
      const selectedRecipients = Array.from(document.getElementById('notification-recipients').selectedOptions).map(option => option.value);
      
      if (selectedRecipients.length === 0) {
        alert('Please select at least one recipient');
        return;
      }
      
      const notificationData = {
        recipient_ids: selectedRecipients.map(id => parseInt(id)),
        subject: formData.get('subject'),
        message: formData.get('message'),
        notification_type: 'admin_message'
      };
      
      try {
        const response = await fetch('/.netlify/functions/send-notification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(notificationData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`Notification sent to ${selectedRecipients.length} recipients!`);
          hideNotificationComposer();
          form.reset();
        } else {
          alert('Error sending notification: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Notification error:', error);
        alert('Error sending notification. Please try again.');
      }
    }
    
    // RSVP-specific notification sending functionality
    async function sendRSVPNotification() {
      if (!requireAuth()) return;
      
      const form = document.getElementById('rsvp-notification-form');
      const formData = new FormData(form);
      const selectedRecipients = Array.from(document.getElementById('rsvp-notification-recipients').selectedOptions).map(option => option.value);
      
      if (selectedRecipients.length === 0) {
        alert('Please select at least one recipient');
        return;
      }
      
      const notificationData = {
        recipient_ids: selectedRecipients.map(id => parseInt(id)),
        subject: formData.get('subject'),
        message: formData.get('message'),
        notification_type: 'admin_message'
      };
      
      // Show sending indicator
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'üìß Sending emails...';
      submitBtn.disabled = true;
      
      try {
        console.log('Sending RSVP notification:', notificationData);
        
        const response = await fetch('/.netlify/functions/send-notification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(notificationData)
        });
        
        const result = await response.json();
        console.log('RSVP notification response:', result);
        
        if (result.success) {
          let successMessage = `‚úÖ ${result.message || 'Emails sent successfully!'}`;
          
          if (result.method) {
            successMessage += `\n\nüìß Email Method: ${result.method}`;
          }
          
          if (result.sentCount && result.totalRecipients) {
            successMessage += `\nüìä Success Rate: ${result.sentCount}/${result.totalRecipients}`;
          }
          
          if (result.recipients && result.recipients.length > 0) {
            successMessage += `\n\nüë• Recipients: ${result.recipients.map(r => r.name).join(', ')}`;
          }
          
          if (result.errors && result.errors.length > 0) {
            successMessage += `\n\n‚ö†Ô∏è Some emails failed:\n${result.errors.slice(0, 3).join('\n')}`;
            if (result.errors.length > 3) {
              successMessage += `\n... and ${result.errors.length - 3} more`;
            }
          }
          
          alert(successMessage);
          hideRSVPNotificationComposer();
          form.reset();
          // Refresh RSVPs to show updated notification status
          loadRSVPs();
        } else {
          let errorMessage = '‚ùå Email sending failed: ' + (result.error || 'Unknown error');
          
          if (result.error && result.error.includes('SENDGRID_API_KEY')) {
            errorMessage += '\n\nüìù Setup Required: Please configure email service:\n';
            errorMessage += '1. Set SENDGRID_API_KEY environment variable in Netlify\n';
            errorMessage += '2. Or configure Netlify Email Integration\n';
          }
          
          alert(errorMessage);
        }
      } catch (err) {
        console.error('Error sending RSVP notification:', err);
        alert('Error sending RSVP notification. Please try again.');
      } finally {
        // Restore button text and re-enable button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }
    
    // Bulk notification function (same as sendNotificationModal for now)
    function sendBulkNotification() {
      sendNotificationModal();
    }
    
    // Setup notification form submission
    document.addEventListener('DOMContentLoaded', function() {
      const notificationForm = document.getElementById('notification-form');
      if (notificationForm) {
        notificationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          sendNotification();
        });
      }
      
      const rsvpNotificationForm = document.getElementById('rsvp-notification-form');
      if (rsvpNotificationForm) {
        rsvpNotificationForm.addEventListener('submit', function(e) {
          e.preventDefault();
          sendRSVPNotification();
        });
      }
    });
    
    // Note: Initial data loading is now handled by showDashboard() after authentication
    
    // Missing function implementations
    
    // Filter guests function
    function filterGuests(filter) {
      if (!requireAuth()) return;
      
      let url = '/.netlify/functions/get-individual-guests';
      if (filter && filter !== 'all') {
        url += `?filter_type=${filter}`;
      }
      
      fetch(url, {
        headers: { 'Authorization': `Bearer ${adminPassword}` }
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          displayGuests(result.data);
        } else {
          document.getElementById('guests-list').innerHTML = '<div class="error">Error filtering guests</div>';
        }
      })
      .catch(error => {
        console.error('Error filtering guests:', error);
        document.getElementById('guests-list').innerHTML = '<div class="error">Error filtering guests</div>';
      });
      
      // Update button states
      const buttons = document.querySelectorAll('#guests-content .controls .btn-secondary');
      buttons.forEach(btn => {
        btn.style.backgroundColor = '#f0f0f0';
        btn.style.color = '#333';
      });
      
      // Highlight active button based on filter
      const buttonIndex = ['primary', 'additional', 'dietary', 'all'].indexOf(filter);
      if (buttonIndex >= 0 && buttons[buttonIndex]) {
        buttons[buttonIndex].style.backgroundColor = '#c8a951';
        buttons[buttonIndex].style.color = 'white';
      }
    }
    
    // Show unassigned guests function
    function showUnassigned() {
      if (!requireAuth()) return;
      
      // Highlight the unassigned section
      const unassignedSection = document.getElementById('unassigned-section');
      unassignedSection.style.border = '2px solid #ff9800';
      unassignedSection.style.backgroundColor = '#fff8e1';
      
      // Load fresh table data to get unassigned guests
      fetch('/.netlify/functions/get-table-data', {
        headers: { 'Authorization': `Bearer ${adminPassword}` }
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          const unassignedGuests = result.data.unassigned_guests || [];
          displayUnassignedGuests(unassignedGuests);
          
          // Scroll to unassigned section
          unassignedSection.scrollIntoView({ behavior: 'smooth' });
          
          // Reset highlight after 3 seconds
          setTimeout(() => {
            unassignedSection.style.border = '';
            unassignedSection.style.backgroundColor = '';
          }, 3000);
        } else {
          document.getElementById('unassigned-list').innerHTML = '<div class="error">Error loading unassigned guests</div>';
        }
      })
      .catch(error => {
        console.error('Error loading unassigned guests:', error);
        document.getElementById('unassigned-list').innerHTML = '<div class="error">Error loading unassigned guests</div>';
      });
    }
    
    // Auto-assign tables function
    async function autoAssignTables() {
      if (!requireAuth()) return;
      
      if (!confirm('This will automatically assign unassigned guests to tables with available space. Continue?')) {
        return;
      }
      
      try {
        // Load current table data
        const response = await fetch('/.netlify/functions/get-table-data', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        const result = await response.json();
        
        if (!result.success) {
          alert('Error loading table data for auto-assignment.');
          return;
        }
        
        const unassignedGuests = result.data.unassigned_guests || [];
        
        if (unassignedGuests.length === 0) {
          alert('All guests are already assigned to tables!');
          return;
        }
        
        // Count current assignments per table
        const tableCapacity = {};
        const maxGuestsPerTable = 4; // Changed to 4 for 50 total guests
        
        // Initialize table capacity tracking
        result.data.tables.forEach(table => {
          tableCapacity[table.table_number] = table.total_guests || table.guests.length;
        });
        
        // Generate assignments
        const assignments = [];
        let currentTable = 1;
        
        for (const guest of unassignedGuests) {
          // Find a table with available space
          while (currentTable <= 20) { // Support up to 20 tables
            const currentCount = tableCapacity[currentTable] || 0;
            
            if (currentCount < maxGuestsPerTable) {
              assignments.push({
                guest_id: guest.guest_id,
                table_number: currentTable
              });
              
              tableCapacity[currentTable] = currentCount + 1;
              break;
            }
            currentTable++;
          }
          
          // If we've run out of tables, create a new one
          if (currentTable > 20) {
            alert('Warning: More than 20 tables would be needed. Please review assignments manually.');
            break;
          }
        }
        
        if (assignments.length === 0) {
          alert('No guests could be auto-assigned. All tables may be full.');
          return;
        }
        
        // Show assignment preview
        const preview = assignments.map(a => {
          const guest = unassignedGuests.find(g => g.guest_id === a.guest_id);
          return `${guest.name} ‚Üí Table ${a.table_number}`;
        }).join('\n');
        
        if (!confirm(`Auto-assign ${assignments.length} guests?\n\n${preview}\n\nContinue?`)) {
          return;
        }
        
        // Submit assignments
        const updateResponse = await fetch('/.netlify/functions/update-table-assignments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ assignments })
        });
        
        const updateResult = await updateResponse.json();
        
        if (updateResult.success) {
          alert(`‚úÖ Successfully auto-assigned ${updateResult.updated_count} guests!\n\nRefreshing table view...`);
          loadTableData(); // Refresh the table display
        } else {
          alert(`‚ùå Auto-assignment failed: ${updateResult.error}`);
        }
        
      } catch (error) {
        console.error('Error auto-assigning tables:', error);
        alert('Error auto-assigning tables. Please try again.');
      }
    }
    
    // Drag and Drop Functionality
    function initializeDragAndDrop() {
      // Add drag and drop event listeners to the table grid
      const tableGrid = document.getElementById('table-grid');
      const unassignedList = document.getElementById('unassigned-list');
      
      if (tableGrid) {
        tableGrid.addEventListener('dragover', handleDragOver);
        tableGrid.addEventListener('drop', handleDrop);
      }
      
      if (unassignedList) {
        unassignedList.addEventListener('dragover', handleDragOver);
        unassignedList.addEventListener('drop', handleDropToUnassigned);
      }
      
      // Make guest items draggable
      document.addEventListener('click', function(e) {
        if (e.target.closest('.guest-item.draggable')) {
          const guestItem = e.target.closest('.guest-item.draggable');
          guestItem.draggable = true;
          guestItem.addEventListener('dragstart', handleDragStart);
          guestItem.addEventListener('dragend', handleDragEnd);
        }
      });
    }
    
    function handleDragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.dataset.guestId);
      e.target.classList.add('dragging');
    }
    
    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.classList.remove('drag-over');
      });
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      const dropZone = e.target.closest('.table-card, .unassigned-section');
      if (dropZone) {
        dropZone.classList.add('drag-over');
      }
    }
    
    function handleDrop(e) {
      e.preventDefault();
      const guestId = e.dataTransfer.getData('text/plain');
      const tableCard = e.target.closest('.table-card');
      
      if (tableCard && guestId) {
        const tableNumber = parseInt(tableCard.querySelector('.table-header span').textContent.replace('Table ', ''));
        assignGuestToTable(parseInt(guestId), tableNumber);
      }
      
      // Clean up drag styling
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }
    
    function handleDropToUnassigned(e) {
      e.preventDefault();
      const guestId = e.dataTransfer.getData('text/plain');
      
      if (guestId) {
        assignGuestToTable(parseInt(guestId), null); // null = unassigned
      }
      
      // Clean up drag styling
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    }
    
    async function assignGuestToTable(guestId, tableNumber) {
      if (!requireAuth()) return;
      
      try {
        const response = await fetch('/.netlify/functions/update-table-assignments', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({
            assignments: [{ guest_id: guestId, table_number: tableNumber }]
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show success feedback
          const message = tableNumber ? `Guest assigned to Table ${tableNumber}` : 'Guest moved to unassigned';
          
          // Create temporary success message
          const successDiv = document.createElement('div');
          successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 10px 20px; border-radius: 6px; z-index: 10001; font-weight: bold;';
          successDiv.textContent = '‚úÖ ' + message;
          document.body.appendChild(successDiv);
          
          setTimeout(() => {
            if (successDiv.parentNode) {
              successDiv.parentNode.removeChild(successDiv);
            }
          }, 3000);
          
          // Refresh table data
          loadTableData();
        } else {
          alert('Failed to update table assignment: ' + result.error);
        }
      } catch (error) {
        console.error('Error assigning guest to table:', error);
        alert('Error updating table assignment. Please try again.');
      }
    }
    
    // Initialize drag and drop when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      // ... existing DOMContentLoaded code ...
      initializeDragAndDrop();
    });
  </script>
</body>
</html>